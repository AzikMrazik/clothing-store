# Настройка домена и Cloudflare для интернет-магазина

В этой инструкции описаны шаги по настройке вашего домена с использованием Cloudflare для защиты и оптимизации работы вашего интернет-магазина.

## 1. Настройка Cloudflare

### Регистрация и добавление домена в Cloudflare

1. Если у вас еще нет аккаунта Cloudflare, [зарегистрируйтесь](https://dash.cloudflare.com/sign-up)
2. После входа в панель управления нажмите "Add a Site" (Добавить сайт)
3. Введите ваш домен (например, clothing-store.com) и нажмите "Add Site"
4. Выберите бесплатный план (Free) и нажмите "Continue"
5. Cloudflare просканирует существующие DNS-записи вашего домена

### Настройка DNS-записей в Cloudflare

1. После сканирования проверьте DNS-записи и убедитесь, что основные записи присутствуют
2. Добавьте запись типа A для основного домена, направленную на IP-адрес вашего VPS:
   - Тип: A
   - Имя: @ (или оставьте поле пустым)
   - IP-адрес: ваш_IP_адрес_VPS
   - Proxy status: включен (оранжевое облако)

3. Добавьте запись для поддомена www:
   - Тип: CNAME
   - Имя: www
   - Значение: @ (или ваш основной домен)
   - Proxy status: включен (оранжевое облако)

4. Нажмите "Continue" для перехода к следующему шагу

### Изменение серверов имен (NS) в регистраторе домена

1. Cloudflare предоставит вам новые серверы имен (обычно это что-то вроде `aida.ns.cloudflare.com` и `syd.ns.cloudflare.com`)
2. Войдите в панель управления вашего регистратора домена (где вы купили домен)
3. Найдите раздел "Nameservers" (Серверы имен)
4. Замените текущие серверы имен на серверы Cloudflare
5. Сохраните изменения

> **Примечание**: Изменение серверов имен может занять до 24-48 часов, хотя обычно происходит в течение нескольких часов.

## 2. Настройка Nginx для работы с доменом

После настройки Cloudflare необходимо обновить конфигурацию Nginx на вашем VPS:

```bash
# Создание или редактирование конфигурационного файла Nginx
sudo nano /etc/nginx/sites-available/clothing-store
```

Добавьте следующую конфигурацию:

```nginx
server {
    listen 80;
    server_name ваш_домен.com www.ваш_домен.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Для статических файлов фронтенда, если они размещены на том же сервере
    location /static/ {
        alias /var/www/clothing-store/frontend/dist/;
        expires 30d;
    }
}
```

Активируйте конфигурацию и перезапустите Nginx:

```bash
sudo ln -s /etc/nginx/sites-available/clothing-store /etc/nginx/sites-enabled/
sudo nginx -t  # Проверка конфигурации
sudo systemctl restart nginx
```

## 3. Установка SSL-сертификата через Certbot

Хотя Cloudflare предоставляет SSL для внешних подключений, также рекомендуется настроить SSL для соединения между Cloudflare и вашим сервером:

```bash
# Установка Certbot
sudo apt update
sudo apt install -y certbot python3-certbot-nginx

# Получение SSL-сертификата
sudo certbot --nginx -d ваш_домен.com -d www.ваш_домен.com
```

## 4. Оптимизация настроек Cloudflare

После установки и проверки правильности работы сайта, оптимизируйте настройки Cloudflare:

### SSL/TLS настройки

1. В панели Cloudflare выберите ваш домен
2. Перейдите в раздел "SSL/TLS"
3. Выберите режим шифрования "Full (strict)" для максимальной безопасности

### Оптимизация производительности

1. Перейдите в раздел "Speed" > "Optimization"
2. Включите Auto Minify для JavaScript, CSS и HTML
3. Включите Brotli сжатие
4. Настройте кэширование:
   - Перейдите в раздел "Caching"
   - Установите уровень кэширования "Standard"
   - Настройте правила для браузерного кэша (Browser Cache TTL)

### Безопасность

1. Перейдите в раздел "Security"
2. Настройте уровень безопасности (Security Level) на "Medium"
3. Включите "Bot Fight Mode" для защиты от простых ботов
4. Включите защиту от DDoS-атак

### Firewall (дополнительно)

1. Перейдите в раздел "Security" > "WAF"
2. Настройте правила для блокировки вредоносного трафика
3. Добавьте правила для блокировки подозрительных IP-адресов

## 5. Настройка CORS для вашего API

Если ваш фронтенд и бэкенд размещены на разных доменах, обновите настройки CORS в вашем бэкенд-приложении:

1. Отредактируйте файл `.env`:

```
# Другие настройки...
CORS_ORIGIN=https://ваш_домен.com
# Добавьте все домены, с которых разрешены запросы, включая www.
```

2. Перезапустите ваше Node.js приложение:

```bash
pm2 restart clothing-store
```

## 6. Обновление информации о домене в приложении

Обновите все жёстко закодированные URL в вашем фронтенде:

1. Измените все абсолютные URL, которые указывают на API, чтобы использовать ваш новый домен
2. Пересоберите фронтенд-приложение:

```bash
cd /var/www/clothing-store/frontend
npm run build
```

## 7. Проверка

После выполнения всех настроек проверьте:

1. Доступность вашего сайта по URL (https://ваш_домен.com)
2. Работоспособность SSL (наличие замка в браузере)
3. Правильность работы всех функций сайта
4. Скорость загрузки с помощью сервисов типа [GTmetrix](https://gtmetrix.com/)

## 8. Регулярное обслуживание (рекомендации)

1. Регулярно проверяйте панель Cloudflare для выявления угроз или проблем
2. Обновляйте SSL-сертификаты перед истечением срока действия
3. Мониторьте производительность и доступность вашего сайта
4. Настройте оповещения о проблемах через Cloudflare

## Дополнительные рекомендации

### Настройка Page Rules в Cloudflare

Создайте правила страниц для специфических URL:

1. В панели Cloudflare перейдите в "Rules" > "Page Rules"
2. Добавьте правило, например, для кэширования статических файлов:
   - URL pattern: `*ваш_домен.com/static/*`
   - Настройки: Cache Level: Cache Everything
   - Edge Cache TTL: 1 month

### Мониторинг через Cloudflare Analytics

Используйте встроенную аналитику Cloudflare для отслеживания трафика, производительности и угроз безопасности.